---
title: "2-Way ANOVA"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(dev = 'svg')
options(device = function(file, width, height) {
  svg(tempfile(), width = width, height = height)
})
```

We talked about the One-Way ANOVA, where you compare differences between 2 or more groups ([Wikipedia][1]).So in the previous topic note we compared IDH1 expression across different diagnoses. But what if we wanted to analyze IDH1 expression across *two* categorical variables, say diagnoses and TERT expression status? For that we would need the two way ANOVA. By performing a Two-Way ANOVA we are testing for ([STHDA][2]):

* Differences between categorical variable A (diagnoses)
* Differences between categorical variable B (TERT Expression Status)
* An interaction between categorical variables A and B (diagnoses and TERT Expression Status)

So let's get to coding!

```{r 2.anova, warning=FALSE,message=FALSE}
load("./lgg.rda")
library(limma)
library(car)
#remember to normalize!
log.trans <- log2(lgg$ExpressionData + 1)
norm.data <- normalizeQuantiles(log.trans)

#grab gender, diagnoses, and IDH1 expression data
tert_expression_status <- lgg$PatientData$paper_TERT.expression.status
diagnosis <- lgg$PatientData$primary_diagnosis
idh1 <- as.numeric(
  norm.data[grepl("IDH1",rownames(norm.data)),]
)
#make a dataframe
df <- data.frame(
  tert_expression_status=tert_expression_status,
  diagnosis=diagnosis,
  idh1=idh1
)
#remove NA's
df1 <- na.omit(df)
#check group membership
table(df1$diagnosis,df1$tert_expression_status)
#let's get to the two-way ANOVA
res <- aov(lm(idh1~tert_expression_status*diagnosis,data = df1))
#summary of the results
Anova(res, type = "III")
```
Here we can see that TERT expression status and diagnosis are associated with IDH1 expression. However, the interaction of the two is not significantly associated with IDH1 expression.To identify which group was deviant we simply plotted the distributions. Note that we use the ```ANOVA()``` function from the car library since our design isn't balanced (that just means we don't have the same number of subjects in each group). Now we face the problem of finding out *which* groups are significantly different. We can get a little more official though by leveraging Tukey Honest Significant Differences and the pairwise t-test ([Wikipedia][2]):

```{r tests,warning=FALSE,message=FALSE}
#let's identify significant differences between diagnoses using the Turkey
#Honest Significant Differences
thsd <- TukeyHSD(res, which = "diagnosis")
thsd[["diagnosis"]][,4][thsd[["diagnosis"]][,4]<0.05]

#now how about the pairwise t-test:
pair.t <- pairwise.t.test(df1$idh1, df1$diagnosis,
                p.adjust.method = "BH")
pair.t[["p.value"]]
#now let's take a look at all the data
library(ggplot2)
ggplot(df1, aes(x=diagnosis, y=idh1,fill=tert_expression_status)) + 
  geom_violin()+
  coord_flip()
```

These results are a tad more official than the simple visual inspection we performed, and we identified more diagnoses with significant differences in means!

## Assumption/Limitations

Now we do need to consider the drawbacks here. Like the One-Way ANOVA, it is assumed that ([Wikipedia][3]):

- independence of the observations
- normality of the residuals (can be tested with the Shapiro Test)
- Variances in each group should be the same (homoscedasticity)

But let's revisit testing these:

```{r testing.time, warning=FALSE,message=FALSE}
#use the car library for homoscedasticity test
plot(res, 1)
leveneTest(idh1~diagnosis*tert_expression_status,data = df1)

#now what about the residuals?
plot(res, 2)
shapiro.test(residuals(res))
```

Here we see that while variances are pretty consistent and the p-value of the levene test asserts that. However, the shapiro test demonstrates that the residuals do not follow a normal distribution. This might be caused by the presence of a non-linear relationship. Still, it is important to explore these metrics to get the best possible understanding of how our data are related.


## References

1. https://en.wikipedia.org/wiki/One-way_analysis_of_variance

2. http://www.sthda.com/english/wiki/two-way-anova-test-in-r

3. https://en.wikipedia.org/wiki/Two-way_analysis_of_variance

[1]: https://en.wikipedia.org/wiki/One-way_analysis_of_variance

[2]: http://www.sthda.com/english/wiki/two-way-anova-test-in-r

[3]: https://en.wikipedia.org/wiki/Two-way_analysis_of_variance